name: Build and Release

on:
  push:
    tags:
      - "v*" # Sadece v1.0.0 gibi tag pushlandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
  workflow_dispatch: # Manuel tetikleme iÃ§in

permissions:
  contents: write

jobs:
  build:
    name: Build .deb Package
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        if: matrix.arch == 'arm64'

      - name: Build with Docker
        run: |
          chmod +x tools/build_docker.sh
          # Docker build scriptini Ã§alÄ±ÅŸtÄ±r (Parametre olarak mimariyi geÃ§iyoruz)
          ./tools/build_docker.sh ${{ matrix.arch }}

      - name: Rename Artifact
        run: |
          # Build Ã§Ä±ktÄ±sÄ±nÄ± bul ve yeniden adlandÄ±r
          mv build_${{ matrix.arch }}/*.deb ro-control_${{ github.ref_name }}_${{ matrix.arch }}.deb || mv *.deb ro-control_${{ github.ref_name }}_${{ matrix.arch }}.deb

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ro-control-${{ matrix.arch }}
          path: ro-control_${{ github.ref_name }}_${{ matrix.arch }}.deb

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v3

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ro-control-amd64/*.deb
            ro-control-arm64/*.deb
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸš€ Yeni SÃ¼rÃ¼m: ${{ github.ref_name }}

            Bu sÃ¼rÃ¼m GitHub Actions tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.

            ### Ä°ndirmeler

            - **Intel/AMD (x86_64):** `ro-control_${{ github.ref_name }}_amd64.deb`
            - **ARM (Raspberry Pi):** `ro-control_${{ github.ref_name }}_arm64.deb`
          draft: false
          prerelease: false
